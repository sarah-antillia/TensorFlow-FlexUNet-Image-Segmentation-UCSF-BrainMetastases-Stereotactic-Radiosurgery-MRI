<h2>TensorFlow-FlexUNet-Image-Segmentation-UCSF-BrainMetastases-Stereotactic-Radiosurgery-MRI (2025/09/17)</h2>

Toshiyuki Arai<br>
Software Laboratory antillia.com<br>
<br>
This is the first experiment of Image Segmentation for <b>The University of California San Francisco Brain Metastases 
Stereotactic Radiosurgery MRI</b> based on 
our <a href="./src/TensorFlowFlexUNet.py">TensorFlowFlexUNet</a>
 (<b>TensorFlow Flexible UNet Image Segmentation Model for Multiclass</b>)
, and a 512x512 pixels PNG dataset which was derived by us from 
<a href="https://imagingdatasets.ucsf.edu/dataset/1">
<b>The University of California San Francisco Brain Metastases Stereotactic Radiosurgery (UCSF-BMSR) MRI Dataset</b></a>
<br><br>
As demonstrated in <a href="https://github.com/sarah-antillia/TensorFlow-FlexUNet-Image-Segmentation-STARE-Retinal-Vessel">
TensorFlow-FlexUNet-Image-Segmentation-STARE-Retinal-Vessel</a> ,
 our Multiclass TensorFlowFlexUNet, which uses categorized masks, can also be applied to 
single-class image segmentation models. 
This is because it inherently treats the background as one category and your single-class mask data as 
a second category. In essence, your single-class segmentation model will operate with two categorized classes within our Multiclass UNet framework.
<br>
<br>
<hr>
<b>Actual Image Segmentation for Images of 512x512 pixels</b><br>
As shown below, the inferred masks predicted by our segmentation model trained on the 
PNG dataset appear similar to the ground truth masks.<br><br>
<table>
<tr>
<td><img src="./projects/TensorFlowFlexUNet/UCSF-BrainMetastases/asset/seg_result_header.png" width="960" height="auto"></td>

<!--
<th>Input: image</th>
<th>Mask (ground_truth)</th>
<th>Prediction: inferred_mask</th>
 -->
</tr>
<tr>

<td><img src="./projects/TensorFlowFlexUNet/UCSF-BrainMetastases/asset/summary_seg_result.png" width="960" height="auto"></td>
<!--

<td><img src="./projects/TensorFlowFlexUNet/UCSF-BrainMetastases/mini_test/images/100103A_1060.png" width="320" height="auto"></td>
<td><img src="./projects/TensorFlowFlexUNet/UCSF-BrainMetastases/mini_test/masks/100103A_1060.png" width="320" height="auto"></td>
<td><img src="./projects/TensorFlowFlexUNet/UCSF-BrainMetastases/mini_test_output/100103A_1060.png" width="320" height="auto"></td>
</tr>
</tr>
<td><img src="./projects/TensorFlowFlexUNet/UCSF-BrainMetastases/mini_test/images/100104A_1081.png" width="320" height="auto"></td>
<td><img src="./projects/TensorFlowFlexUNet/UCSF-BrainMetastases/mini_test/masks/100104A_1081.png" width="320" height="auto"></td>
<td><img src="./projects/TensorFlowFlexUNet/UCSF-BrainMetastases/mini_test_output/100104A_1081.png" width="320" height="auto"></td>
</tr>
<tr>
<td><img src="./projects/TensorFlowFlexUNet/UCSF-BrainMetastases/mini_test/images/100412A_1056.png" width="320" height="auto"></td>
<td><img src="./projects/TensorFlowFlexUNet/UCSF-BrainMetastases/mini_test/masks/100412A_1056.png" width="320" height="auto"></td>
<td><img src="./projects/TensorFlowFlexUNet/UCSF-BrainMetastases/mini_test_output/100412A_1056.png" width="320" height="auto"></td>
 -->
</tr>
</table>

<hr>
<br>

<h3>1 Dataset Citation</h3>
The dataset used here was obtained from
<br><br>
<a href="https://imagingdatasets.ucsf.edu/dataset/1">
<b>The University of California San Francisco Brain Metastases Stereotactic Radiosurgery (UCSF-BMSR) MRI Dataset</b></a>
<br><br>
<b>Description</b><br>
The University of California San Francisco Brain Metastases Stereotactic Radiosurgery (UCSF-BMSR) dataset is a public,
 clinical, multimodal brain MRI dataset consisting of 560 brain MRIs from 412 patients with expert 
 annotations of 5136 brain metastases. Data consists of registered and skull stripped T1 post-contrast, T1 pre-contrast,
  FLAIR and subtraction (T1 pre-contrast - T1 post-contrast) images and voxelwise segmentations of
   enhancing brain metastases in NifTI format. The dataset also includes patient demographics, 
   surgical status and primary cancer types. Currently 461 exams are available for download at the 
   UCSF center for Intelligent Imaging website. The remaining data will become available after the 
   2024 MICCAI/BraTS challenge. The UCSF-BSMR has been made publicly available in the hopes that researchers 
   will use these data to push the boundaries of AI applications for brain metastases.
<br>
<br>
For more information on the pretrained models for segmentation and skull stripping please 
visit: https://github.com/rachitsaluja/UCSF-BMSR-benchmarks
<br>
<br>
<b>Authors</b><br>
Jeffrey D. Rudie MD PhD, Rachit Saluja MSE, David A. Weiss MSE, Pierre Nedelec, 
Evan Calabrese MD PhD, John B. Colby MD PhD, Benjamin Laguna MD, John Mongan MD PhD, 
Steve Braunstein MD PhD, Christopher P. Hess MD PhD, Andreas M. Rauschecker MD PhD, 
Leo P. Sugrue MD PhD, Javier E. Villanueva-Meyer MD
<br>
<br>
<b>How to Cite</b><br>
<li><a href="https://arxiv.org/abs/2304.07248">https://arxiv.org/abs/2304.07248</a></li>
<li><a href="https://pubs.rsna.org/doi/10.1148/ryai.230126">https://pubs.rsna.org/doi/10.1148/ryai.230126</a></li>
<br>
<b>DOI</b><br>
doi:10.58078/C24W2K
<br>
<br>
<b>Version</b><br>
1.3
<br>
<br>
<h3>
2 UCSF-BrainMetastases ImageMask Dataset
</h3>
<h3>2.1 ImageMask Dataset Generation</h3>
 If you would like to train this UCSF-BrainMetastases Segmentation model by yourself,
 you have to generate the PNG dataset by using the following Python scripts:
 <br><br>
<li><a href="./generator/ImageMaskDatasetGenerator.py">ImageMaskDatasetGenerator.py</a></li>
<li><a href="./generator/split_master.py">split_master.py</a></li>
<br>

The files and folders to generate the dataset will take the following structure:<br>
<pre>
./generetor
 ├─ImageMaskDatasetGeneratory.py
 ├─split_master.py
 └─UCSF_BrainMetastases_v1.3 
       └─UCSF_BRAINMETASTASES_TRAIN 
</pre>
<br>
 The first generator script generates a master image and mask dataset
of 512x512 pixels PNG format from <b>100*_seg.nii.gz</b> and <b>100*_T1post.nii.gz</b>
 in subfolder under UCSF_BRAINMETASTASES_TRAIN folder.
By changing a few lines in the generator, you can create a different type of image and mask dataset
from this.<br>
<br>
<pre>
./UCSF_BRAINMETASTASES_TRAIN
 ├─100101A
 │   ├─100101A_seg.nii.gz
 │   └─100101A_T1post.nii.gz
 ├─100102A
 │   ├─100102A_seg.nii.gz
 │   └─100102A_T1post.nii.gz
...
 └─100414B
      ├─100414B_seg.nii.gz
      └─100414B_T1post.nii.gz
</pre>
 The second splitter simply splits the master into test, train and valid subsets. <br>

By running these Python scripts, finally a 512x512 pixels PNG UCSF-BrainMetastases dataset will be 
created under <b>dataset</b> folder as shown below.<b></b>.  

<pre>
./dataset
└─UCSF-BrainMetastases
    ├─test
    │   ├─images
    │   └─masks
    ├─train
    │   ├─images
    │   └─masks
    └─valid
        ├─images
        └─masks
</pre>
<b>UCSF-BrainMetastases Statistics</b><br>
<img src ="./projects/TensorFlowFlexUNet/UCSF-BrainMetastases/UCSF-BrainMetastases_Statistics.png" width="512" height="auto"><br>
<br>
As shown above, the number of images of train and valid datasets is large enough to use for a training set of our segmentation model.
<br><br>
<b>You may not redistribute this PNG dataset generated from UCSF-BMSR MRI Dataset, and 
commercial use of this dataset is prohibited.</b> <br>
<br>

<h3>2.2 Mini-test Dataset Generation</h3>

You also have to generate a <b>mini_test</b> dataset from <b>UCSF-BrainMetastases/test</b> subset by yourself, 
depending on your choices,
which can be used in EpochChangeInferencer Callback and an actual segmentation (predictioin) process.
<br>
<pre>
./projects
└─TensorflowFlexUNet
       └─UCSF-BrainMetastases
             └─mini_test
                ├─images
                └─masks
</pre>
<!--
<b>You may not redistribute your own mini_test dataset.</b><br>
-->
<br>
<br>
<h3>2.3 Tran Images and Masks Sample </h3>
<b>Train_images_sample</b><br>
<img src="./projects/TensorFlowFlexUNet/UCSF-BrainMetastases/asset/train_images_sample.png" width="1024" height="auto">
<br>
<b>Train_masks_sample</b><br>
<img src="./projects/TensorFlowFlexUNet/UCSF-BrainMetastases/asset/train_masks_sample.png" width="1024" height="auto">
<br>
<br>
<h3>
3 Train TensorFlowUNet Model
</h3>
 We have trained UCSF-BrainMetastases TensorFlowUNet Model by using the following
<a href="./projects/TensorFlowFlexUNet/UCSF-BrainMetastases/train_eval_infer.config"> <b>train_eval_infer.config</b></a> file. <br>
Please move to ./projects/TensorFlowFlexUNet/UCSF-BrainMetastasesand, and run the following bat file.<br>
<pre>
>1.train.bat
</pre>
, which simply runs the following command.<br>
<pre>
>python ../../../src/TensorFlowUNetTrainer.py ./train_eval_infer.config
</pre>
<hr>

<b>Model parameters</b><br>
Defined a small <b>base_filters = 16</b> and large <b>base_kernels = (7,7)</b> for the first Conv Layer of Encoder Block of 
<a href="./src/TensorFlowUNet.py">TensorFlowUNet.py</a> 
and a large num_layers (including a bridge between Encoder and Decoder Blocks).
<pre>
[model]
image_width    = 512
image_height   = 512
image_channels = 3

num_classes    = 2

base_filters   = 16
base_kernels   = (7,7)
num_layers     = 8
dropout_rate   = 0.04
dilation       = (1,1)

</pre>

<b>Learning rate</b><br>
Defined a very small learning rate.  
<pre>
[model]
learning_rate  = 0.00007
</pre>

<b>Online augmentation</b><br>
Disabled our online augmentation.  
<pre>
[model]
model         = "TensorFlowUNet"
generator     = False
</pre>

<b>Loss and metrics functions</b><br>
Specified "categorical_crossentropy" and <a href="./src/dice_coef_multiclass.py">"dice_coef_multiclass"</a>.<br>
You may specify other loss and metrics function names.<br>
<pre>
[model]
loss           = "categorical_crossentropy"
metrics        = ["dice_coef_multiclass"]
</pre>
<b>Learning rate reducer callback</b><br>
Enabled learing_rate_reducer callback, and a small reducer_patience.
<pre> 
[train]
learning_rate_reducer = True
reducer_factor     = 0.5
reducer_patience   = 4
</pre>

<b>Early stopping callback</b><br>
Enabled early stopping callback with patience parameter.
<pre>
[train]
patience      = 10
</pre>

<b>RGB Color map</b><br>
rgb color map dict for UCSF-BrainMetastases 1+1 classes.
<pre>
[mask]
mask_datatype    = "categorized"
mask_file_format = ".png"

;     Background   UCSF-BrainMetastases: white 
rgb_map = {(0,0,0):0,(255, 255, 255):1,}
</pre>

<b>Epoch change inference callback</b><br>
Enabled <a href="./src/EpochChangeInferencer.py">epoch_change_infer callback (EpochChangeInferencer.py)</a></b>.<br>
<pre>
[train]
epoch_change_infer       = True
epoch_change_infer_dir   =  "./epoch_change_infer"
num_infer_images         = 6
</pre>

By using this callback, on every epoch_change, the inference procedure can be called
 for 6 images in <b>mini_test</b> folder. This will help you confirm how the predicted mask changes 
 at each epoch during your training process.<br> <br> 

<b>Epoch_change_inference output at starting (epoch 1,2,3)</b><br>
<img src="./projects/TensorFlowFlexUNet/UCSF-BrainMetastases/asset/epoch_change_infer_at_start.png" width="1024" height="auto"><br>
<br>
<b>Epoch_change_inference output at middlepoint (epoch 15,16,17)</b><br>
<img src="./projects/TensorFlowFlexUNet/UCSF-BrainMetastases/asset/epoch_change_infer_at_middlepoint.png" width="1024" height="auto"><br>
<br>

<b>Epoch_change_inference output at ending (epoch 32,33,34)</b><br>
<img src="./projects/TensorFlowFlexUNet/UCSF-BrainMetastases/asset/epoch_change_infer_at_end.png" width="1024" height="auto"><br>
<br>


In this experiment, the training process was terminated at epoch 34.<br><br>
<img src="./projects/TensorFlowFlexUNet/UCSF-BrainMetastases/asset/train_console_output_at_epoch34.png" width="720" height="auto"><br>
<br>

<a href="./projects/TensorFlowFlexUNet/UCSF-BrainMetastases/eval/train_metrics.csv">train_metrics.csv</a><br>
<img src="./projects/TensorFlowFlexUNet/UCSF-BrainMetastases/eval/train_metrics.png" width="520" height="auto"><br>

<br>
<a href="./projects/TensorFlowFlexUNet/UCSF-BrainMetastases/eval/train_losses.csv">train_losses.csv</a><br>
<img src="./projects/TensorFlowFlexUNet/UCSF-BrainMetastases/eval/train_losses.png" width="520" height="auto"><br>

<br>

<h3>
4 Evaluation
</h3>
Please move to a <b>./projects/TensorFlowFlexUNet/UCSF-BrainMetastases</b> folder,<br>
and run the following bat file to evaluate TensorFlowUNet model for UCSF-BrainMetastases.<br>
<pre>
./2.evaluate.bat
</pre>
This bat file simply runs the following command.
<pre>
python ../../../src/TensorFlowUNetEvaluator.py ./train_eval_infer_aug.config
</pre>

Evaluation console output:<br>
<img src="./projects/TensorFlowFlexUNet/UCSF-BrainMetastases/asset/evaluate_console_output_at_epoch34.png" width="720" height="auto">
<br><br>Image-Segmentation-UCSF-BrainMetastases

<a href="./projects/TensorFlowFlexUNet/UCSF-BrainMetastases/evaluation.csv">evaluation.csv</a><br>

The loss (bce_dice_loss) to this UCSF-BrainMetastases/test was very low, but dice_coef very high as shown below.
<br>
<pre>
categorical_crossentropy,0.0015
dice_coef_multiclass,0.9993
</pre>
<br>
<h3>
5 Inference
</h3>
Please move to a <b>./projects/TensorFlowFlexUNet/UCSF-BrainMetastases</b> folder<br>
,and run the following bat file to infer segmentation regions for images by the Trained-TensorFlowUNet model for UCSF-BrainMetastases.<br>
<pre>
./3.infer.bat
</pre>
This simply runs the following command.
<pre>
python ../../../src/TensorFlowUNetInferencer.py ./train_eval_infer_aug.config
</pre>
<hr>
<b>mini_test_images</b><br>
<img src="./projects/TensorFlowFlexUNet/UCSF-BrainMetastases/asset/mini_test_images.png" width="1024" height="auto"><br>
<b>mini_test_mask(ground_truth)</b><br>
<img src="./projects/TensorFlowFlexUNet/UCSF-BrainMetastases/asset/mini_test_masks.png" width="1024" height="auto"><br>

<hr>
<b>Inferred test masks</b><br>
<img src="./projects/TensorFlowFlexUNet/UCSF-BrainMetastases/asset/mini_test_output.png" width="1024" height="auto"><br>
<br>
<hr>
<b>Enlarged images and masks </b><br>
<br>
<table>
<tr>
<td><img src="./projects/TensorFlowFlexUNet/UCSF-BrainMetastases/asset/seg_result_header.png" width="960" height="auto"></td>

<!--
<th>Image</th>
<th>Mask (ground_truth)</th>
<th>Inferred-mask</th>
-->
</tr>
<tr>
<td><img src="./projects/TensorFlowFlexUNet/UCSF-BrainMetastases/asset/seg_result_1.png" width="960" height="auto"></td>

</tr>
<tr>
<td><img src="./projects/TensorFlowFlexUNet/UCSF-BrainMetastases/asset/seg_result_2.png" width="960" height="auto"></td>

</tr>


<!--
<td><img src="./projects/TensorFlowFlexUNet/UCSF-BrainMetastases/mini_test/images/100101A_1079.png" width="320" height="auto"></td>
<td><img src="./projects/TensorFlowFlexUNet/UCSF-BrainMetastases/mini_test/masks/100101A_1079.png" width="320" height="auto"></td>
<td><img src="./projects/TensorFlowFlexUNet/UCSF-BrainMetastases/mini_test_output/100101A_1079.png" width="320" height="auto"></td>
</tr>
<tr>
<td><img src="./projects/TensorFlowFlexUNet/UCSF-BrainMetastases/mini_test/images/100102A_1058.png" width="320" height="auto"></td>
<td><img src="./projects/TensorFlowFlexUNet/UCSF-BrainMetastases/mini_test/masks/100102A_1058.png" width="320" height="auto"></td>
<td><img src="./projects/TensorFlowFlexUNet/UCSF-BrainMetastases/mini_test_output/100102A_1058.png" width="320" height="auto"></td>
</tr>
<tr>
<td><img src="./projects/TensorFlowFlexUNet/UCSF-BrainMetastases/mini_test/images/100105A_1062.png" width="320" height="auto"></td>
<td><img src="./projects/TensorFlowFlexUNet/UCSF-BrainMetastases/mini_test/masks/100105A_1062.png" width="320" height="auto"></td>
<td><img src="./projects/TensorFlowFlexUNet/UCSF-BrainMetastases/mini_test_output/100105A_1062.png" width="320" height="auto"></td>
</tr>
<tr>
<td><img src="./projects/TensorFlowFlexUNet/UCSF-BrainMetastases/mini_test/images/100411A_1052.png" width="320" height="auto"></td>
<td><img src="./projects/TensorFlowFlexUNet/UCSF-BrainMetastases/mini_test/masks/100411A_1052.png" width="320" height="auto"></td>
<td><img src="./projects/TensorFlowFlexUNet/UCSF-BrainMetastases/mini_test_output/100411A_1052.png" width="320" height="auto"></td>
</tr>
<tr>
<td><img src="./projects/TensorFlowFlexUNet/UCSF-BrainMetastases/mini_test/images/100412B_1070.png" width="320" height="auto"></td>
<td><img src="./projects/TensorFlowFlexUNet/UCSF-BrainMetastases/mini_test/masks/100412B_1070.png" width="320" height="auto"></td>
<td><img src="./projects/TensorFlowFlexUNet/UCSF-BrainMetastases/mini_test_output/100412B_1070.png" width="320" height="auto"></td>
</tr>
<tr>
<td><img src="./projects/TensorFlowFlexUNet/UCSF-BrainMetastases/mini_test/images/100413A_1081.png" width="320" height="auto"></td>
<td><img src="./projects/TensorFlowFlexUNet/UCSF-BrainMetastases/mini_test/masks/100413A_1081.png" width="320" height="auto"></td>
<td><img src="./projects/TensorFlowFlexUNet/UCSF-BrainMetastases/mini_test_output/100413A_1081.png" width="320" height="auto"></td>
</tr>
-->
</table>
<hr>
<br>

<h3>Acknowledgments</h3>
We sincerely appreciate the cooperation and advice of John Mongan, MD, PhD<br>
<br>
Associate Chair, Translational Informatics<br>
Professor of Clinical Radiology<br>
Department of Radiology and Biomedical Imaging<br>
University of California San Francisco<br>
<br>
<br>

<h3>
References
</h3>

<b>1. The University of California San Francisco Brain Metastases Stereotactic Radiosurgery (UCSF-BMSR) MRI Dataset</b><br>

Jeffrey D Rudie,✉, Rachit Saluja, David A Weiss, Pierre Nedelec, Evan Calabrese, <br>
John B Colby, Benjamin Laguna, John Mongan, Steve Braunstein, Christopher P Hess, <br>
Andreas M Rauschecker, Leo P Sugrue, Javier E Villanueva-Meyer<br>

<a href="https://pmc.ncbi.nlm.nih.gov/articles/PMC10982817/">https://pmc.ncbi.nlm.nih.gov/articles/PMC10982817/</a>


<br>
<br>
<b>2. UCSF-BMSR-benchmarks</b><br>
Rachit Saluja<br>
<a href="https://github.com/rachitsaluja/UCSF-BMSR-benchmarks">
https://github.com/rachitsaluja/UCSF-BMSR-benchmarks</a>
<br>
The official nnUNet benchmarks for 
<a href="https://imagingdatasets.ucsf.edu/dataset/1">

The University of California San Francisco Brain Metastases Stereotactic Radiosurgery (UCSF-BMSR) dataset.
</a>
<br>
<br>

